## A Deconvolutional Neural Network for Plasma Tomography

This repository contains a neural network that produces tomographic reconstructions similar to those available at JET.

### Requirements

- Keras 2.1.2, TensorFlow 1.4.1

- Configure `~/.keras/keras.json` as follows:

```
{
    "image_data_format": "channels_last",
    "epsilon": 1e-07,
    "floatx": "float32",
    "backend": "tensorflow"
}

```

### Instructions

1. Run `python get_data.py` to get all the available tomographic reconstructions for training.

    - This script will only run on a JET computing cluster (e.g. Freia).
    
    - `reliable_only` specifies whether the training set should include reliable reconstructions only.

    - An output file `train_data.hdf` will be created.

2. Run `python split_data.py` to split the train data into training set and validation set.

    - This will create the two datasets (`X_train.npy`, `Y_train.npy`) and (`X_valid.npy`, `Y_valid.npy`).

3. Run `CUDA_VISIBLE_DEVICES=0 TF_CPP_MIN_LOG_LEVEL=1 python -W ignore model_train.py` to train the model.

    - Change `CUDA_VISIBLE_DEVICES=0` to the device number you would like to use.
    
    - `TF_CPP_MIN_LOG_LEVEL=1` reduces the verbosity level of TensorFlow.
    
    - `-W ignore` supresses some Python warnings.

    - Training will finish automatically once the validation loss no longer improves.
    
    - The best model parameters will be saved in `model_weights.hdf`.

4. After (or during) training, run `python plot_loss.py` to plot the loss and validation loss across epochs.

    - The script will also indicate the epoch where the minimum validation loss was achieved.
    
5. After training, run `TF_CPP_MIN_LOG_LEVEL=1 python model_valid.py` to test the model on the validation data.

    - This step does not need to be run on a GPU, it can be run with TensorFlow on the CPU.

    - Check that the reported `val_loss` is the same as indicated by `plot_loss.py`.

6. Run `TF_CPP_MIN_LOG_LEVEL=1 python model_test.py` to test the model on a given pulse.

    - Before running this script, set the desired pulse, start time (`t0`), end time (`t1`), and time step (`dt`).

    - Since this script will grab the bolometer data for the test pulse, it needs to run on a JET computing cluster.
    
    - Again, this step does not need to be run on a GPU, it can be run with TensorFlow on the CPU.

    - An output file `test_data.hdf` will be created.

7. Run `python plot_frames.py` to plot the reconstructions generated by the model for the test pulse.

    - These will be built from the test data in `test_data.hdf`.
    
    - If needed, adjust `vmax` to change the dynamic range of the plots.

8. Run `python plot_movie.py` to produce a movie of the reconstructions for the test pulse.

    - This will be built from the test data in `test_data.hdf`.

    - If needed, adjust `vmax` to change the dynamic range.


### Reference

- D.R. Ferreira, P.J. Carvalho, H. Fernandes, [_Full-Pulse Tomographic Reconstruction with Deep Neural Networks_](https://arxiv.org/pdf/1802.02242.pdf), Fusion Science and Technology, vol. 74, no. 1-2, pp. 47-56, 2018 [[BibTeX](https://www.tandfonline.com/action/downloadCitation?doi=10.1080/15361055.2017.1390386&format=bibtex)]
